<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Einstellungen</title>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #8ecae6 0%, #fff 100%);
      /* SkyMode default */
      transition: background 0.6s;
    }
    body.night {
      background: linear-gradient(120deg, #fbc2eb 0%, #a6c1ee 100%);
    }
    .clouds {
      position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none; z-index: 0; opacity: 0.35;
      background: url('data:image/svg+xml;utf8,<svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="60" cy="90" rx="55" ry="32" fill="%23fff"/><ellipse cx="120" cy="110" rx="55" ry="30" fill="%23fff"/><ellipse cx="170" cy="90" rx="50" ry="25" fill="%23fff"/></svg>');
      background-repeat: repeat-x;
      animation: cloudmove 60s linear infinite;
    }
    @keyframes cloudmove {
      from { background-position-x: 0; }
      to   { background-position-x: -400px; }
    }
    .dialog {
      position: relative; z-index: 1;
      border-radius: 24px;
      padding: 2.2rem 2.5rem 1.5rem 2.5rem;
      min-width: 380px;
      max-width: 430px;
      box-shadow: 0 8px 42px rgba(60, 80, 160, 0.16), 0 2px 8px #fff3;
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(2px);
      border: none;
      display: flex; flex-direction: column;
      gap: 1.2rem;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem;
    }
    .header h1 {
      font-size: 2rem; margin: 0;
      font-weight: 900; letter-spacing: -1px;
      text-shadow: 0 3px 18px #9be5fc7a;
    }
    .close-btn {
      background: transparent; border: none; font-size: 2rem;
      color: #db2777; cursor: pointer; font-weight: 400;
      transition: color 0.2s;
    }
    .close-btn:hover { color: #0284c7; }
    .options { display: flex; flex-direction: column; gap: 1.2rem; }
    label.option, .dropdown-label {
      font-size: 1.17rem;
      font-weight: 600;
      display: flex; align-items: center; gap: 0.8em;
    }
    input[type="checkbox"] {
      accent-color: #38bdf8;
      width: 1.35em; height: 1.35em;
      border-radius: 5px; margin-right: 0.7em;
      box-shadow: 0 0 2px #0ea5e9;
      cursor: pointer;
    }
    input[type="number"], select {
      border: 1.5px solid #bae6fd;
      border-radius: 8px;
      padding: 0.4em 0.8em; margin-left: 0.6em; font-size: 1.07em;
      background: #f0faff; color: #334155; font-weight: 500;
      transition: box-shadow 0.2s;
    }
    input[type="number"]:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #7dd3fc;
    }
    .buttons { display: flex; justify-content: flex-end; gap: 1.5em; margin-top: 2em;}
    button {
      padding: 0.5em 1.6em;
      font-size: 1.1em;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      background: linear-gradient(93deg, #38bdf8 10%, #f472b6 90%);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px #bae6fd50;
      transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover { background: linear-gradient(90deg, #0ea5e9, #db2777);}
    button#cancelBtn {
      background: #e0e7ef;
      color: #64748b;
      font-weight: 500;
      box-shadow: none;
    }
    button#cancelBtn:hover { background: #cbd5e1; color: #000; }
    .ollama-info {
      margin-top: 1.2em; color: #dc2626; font-weight: bold; text-align: center;
    }
  </style>
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    // Elemente holen
    const cbSky       = document.getElementById('skymode');
    const cbSkip      = document.getElementById('skipPrompt');
    const thresholdInput = document.getElementById('intelligentCommitThresholdInput');
    const ok          = document.getElementById('okBtn');
    const cancel      = document.getElementById('cancelBtn');
    const close       = document.getElementById('closeBtn');
    const [initialSky, initialSkip, initialThreshold] = await Promise.all([
      window.settingsAPI.getSkyMode(),
      window.settingsAPI.getSkipPrompt(),
      window.electronAPI.getIntelligentCommitThreshold()
    ]);

    const sky = await (window.settingsAPI?.getSkyMode?.() || Promise.resolve(true));
    document.body.classList.toggle('night', !sky);
    
    // Inputs setzen
    cbSky.checked        = initialSky;
    cbSkip.checked       = initialSkip;
    thresholdInput.value = initialThreshold;

    // **Vorschau**: Sky-Mode sofort übernehmen
    cbSky.addEventListener('change', async () => {
      await window.settingsAPI.setSkyMode(cbSky.checked);
    });


    // OK: alles final speichern
    ok.addEventListener('click', async () => {
      await window.settingsAPI.setSkipPrompt(cbSkip.checked);
      // SkyMode haben wir ja schon beim Change gesetzt

      // Threshold speichern (immer Wert aus Feld nehmen!)
      let threshold = parseInt(thresholdInput.value, 10);
      if (isNaN(threshold)) threshold = 10;
      if (threshold < 1) threshold = 1;
      if (threshold > 1000) threshold = 1000;
      await window.settingsAPI.setIntelligentCommitThreshold(threshold);

      // Dropdowns speichern
      const commitSel = document.getElementById('commitModelSelect');
      const readmeSel = document.getElementById('readmeModelSelect');
      alert('OK gedrückt');
      if (commitSel) await window.settingsAPI.setCommitModel(commitSel.value);
      if (readmeSel)  await window.settingsAPI.setReadmeModel(readmeSel.value);

      window.settingsAPI.close();
    });

    // Cancel / Close: SkyMode zurücksetzen, dann schließen
    const rollback = async () => {
      await window.settingsAPI.setSkyMode(initialSky);
      window.settingsAPI.close();
    };
    cancel.addEventListener('click', rollback);
    close.addEventListener('click',  rollback);


  const container = document.getElementById('ollama-model-selectors');
  const res = await window.electronAPI.ollamaList();

  if (res.status === 'no-cli') {
    container.innerHTML = `
      <div style="color:red;font-weight:bold;margin:1em 0;">
        !! You need to install Ollama to use intelligent message & README generation !!
      </div>`;
    return;
  }

  if (res.status === 'error') {
    container.innerHTML = `<div style="color:orange">Error fetching models: ${res.msg}</div>`;
    return;
  }

  // Liste der Modell-Namen extrahieren
  const names = res.models.map(m => m.name || m.model).filter(Boolean);
  const qwen = names.filter(n => /^qwen2\.5-coder(:[\w\-.]+)?$/.test(n));

  if (!qwen.length) {
    // keine qwen2.5-coder → Pull-Buttons
    container.innerHTML = `
      <button id="pullCommitModelBtn" style="margin-bottom:8px;">
        ollama pull qwen2.5-coder:7b
      </button><br>
      <button id="pullReadmeModelBtn">
        ollama pull qwen2.5-coder:32b
      </button>`;
    document.getElementById('pullCommitModelBtn').onclick = async () => {
      await window.electronAPI.ollamaPull('qwen2.5-coder:7b');
      location.reload();
    };
    document.getElementById('pullReadmeModelBtn').onclick = async () => {
      await window.electronAPI.ollamaPull('qwen2.5-coder:32b');
      location.reload();
    };
    return;
  }

  // Dropdowns aufbauen
  const makeOpts = (arr, sel) =>
    arr.map(m => `<option ${m===sel?'selected':''}>${m}</option>`).join('');

  // Default-Auswahl aus Settings (oder erstes gefundenes)
  const commitDefault = qwen.find(m=>m.includes('7b'))||qwen[0];
  const readmeDefault= qwen.find(m=>m.includes('32b'))||qwen[0];
  const currentCommit = await window.settingsAPI.getCommitModel?.() || commitDefault;
  const currentReadme= await window.settingsAPI.getReadmeModel?.() || readmeDefault;

  container.innerHTML = `
    <label>Model for commit message generation:
      <select id="commitModelSelect">
        ${makeOpts(qwen, currentCommit)}
      </select>
    </label><br>
    <label>Model for README generation:
      <select id="readmeModelSelect">
        ${makeOpts(qwen, currentReadme)}
      </select>
    </label>`;
});
  </script>
</head>
<body>
  <div class="clouds"></div>
  <div class="dialog">
    <div class="header">
      <h1>Settings</h1>
      <button class="close-btn" id="closeBtn">✕</button>
    </div>
    <div class="options">
      <label class="option">
        <input type="checkbox" id="skymode" />
        Sky Mode
      </label>
      <label class="option">
        <input type="checkbox" id="skipPrompt" />
        Skip prompt asking to remove .git folder if it has only one commit and no changes
      </label>
      <label class="dropdown-label">
        Intelligent commit after
        <input type="number" id="intelligentCommitThresholdInput" min="1" max="1000" value="10" step="1">
        lines of diff
      </label>
      <label class="dropdown-label">
        Model for commit message generation:
        <select id="commitModelSelect">
          <option>qwen2.5-coder:7b</option>
        </select>
      </label>
      <label class="dropdown-label">
        Model for README generation:
        <select id="readmeModelSelect">
          <option>qwen2.5-coder:32b</option>
        </select>
      </label>
      <div class="ollama-info" id="ollamaInfo"></div>
    </div>
    <div class="buttons">
      <button id="cancelBtn">Cancel</button>
      <button id="okBtn">OK</button>
    </div>
  </div>
</body>
</html>